<!DOCTYPE html>
<html>
  <head>
    <title>Test Payment</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script
      src="https://app.sandbox.midtrans.com/snap/snap.js"
      data-client-key="<%= process.env.MIDTRANS_CLIENT_KEY %>"
    ></script>
  </head>
  <body
    class="d-flex vh-100 justify-content-center align-items-center flex-column"
  >
    <h1>Halaman Test Payment</h1>
    <p>Halo, <%= user.fullname %>!</p>
    <p>Alamat: <%= user.address %></p>

    <button id="pay-button" class="btn btn-success">Checkout</button>

    <script>
      document
        .getElementById("pay-button")
        .addEventListener("click", async () => {
          try {
            // üîπ Ambil token dari backend
            const res = await fetch("/checkout", { method: "POST" });
            const token = await res.text();

            // üîπ Panggil popup Midtrans
            window.snap.pay(token, {
              onSuccess: function (result) {
                console.log("‚úÖ SUCCESS callback dipanggil", result);
                window.location.href = "/home";
              },
              onPending: function (result) {
                console.log("‚åõ PENDING callback dipanggil", result);
                window.location.href = "/home";
              },
              onError: function (result) {
                console.log("‚ùå ERROR callback dipanggil", result);
                window.location.href = "/home";
              },
              onClose: function () {
                console.log("üö™ CLOSE callback dipanggil");
                window.location.href = "/home";
              },
            });
          } catch (err) {
            console.error("Checkout gagal:", err);
          }
        });
    </script>
  </body>
</html>
